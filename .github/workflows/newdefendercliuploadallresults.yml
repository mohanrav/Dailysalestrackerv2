
# Note by Mohan. This workflow does not fail the pipeline. 

name: Defender CLI â€“ Multi-scanner with MDC upload

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

permissions:
  contents: read
  id-token: write
  actions: read
  security-events: write

jobs:
  security-scan:
    runs-on: windows-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v3

    - name: Ensure SARIF directory
      shell: pwsh
      run: New-Item -ItemType Directory -Path sarif -Force | Out-Null

    # CHECKOV
    - name: Install Checkov
      shell: pwsh
      continue-on-error: true
      run: pip install checkov

    - name: Run Checkov
      shell: pwsh
      continue-on-error: true
      run: |
        checkov -d . -o sarif | Out-File -FilePath sarif/checkov.sarif -Encoding utf8

    # TERRASCAN (with null-safe asset lookup)
    - name: Install Terrascan
      shell: pwsh
      continue-on-error: true
      run: |
        $release = Invoke-RestMethod -Uri "https://api.github.com/repos/tenable/terrascan/releases/latest"
        $asset = $release.assets | Where-Object { $_.name -like "*windows_amd64.zip*" }
        if (-not $asset) {
          Write-Host "No Windows Terrascan asset found. Skipping Terrascan install."
          exit 0
        }
        Invoke-WebRequest -Uri $asset.browser_download_url -OutFile terrascan.zip
        Expand-Archive terrascan.zip -DestinationPath $env:USERPROFILE\terrascan -Force
        echo "$env:USERPROFILE\terrascan" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append

    - name: Run Terrascan
      shell: pwsh
      continue-on-error: true
      run: terrascan scan -o sarif | Out-File -FilePath sarif/terrascan.sarif -Encoding utf8

    # TRIVY
    - name: Install Trivy
      shell: pwsh
      continue-on-error: true
      run: |
        Invoke-WebRequest -Uri "https://github.com/aquasecurity/trivy/releases/download/v0.67.0/trivy_0.67.0_windows-64bit.zip" -OutFile trivy.zip
        Expand-Archive trivy.zip -DestinationPath $env:USERPROFILE\trivy -Force
        echo "$env:USERPROFILE\trivy" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append

    - name: Run Trivy for secrets
      shell: pwsh
      continue-on-error: true
      run: trivy fs --scanners secret --format sarif --output sarif/trivy.sarif .

    # GITLEAKS
    - name: Install Gitleaks
      shell: pwsh
      continue-on-error: true
      run: |
        Invoke-WebRequest -Uri "https://github.com/gitleaks/gitleaks/releases/download/v8.18.1/gitleaks_8.18.1_windows_x64.zip" -OutFile gitleaks.zip
        Expand-Archive gitleaks.zip -DestinationPath $env:USERPROFILE\gitleaks -Force
        echo "$env:USERPROFILE\gitleaks" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append

    - name: Run Gitleaks
      shell: pwsh
      continue-on-error: true
      run: gitleaks detect --report-format sarif --report-path sarif/gitleaks.sarif

    # Upload individual SARIFs to GitHub (optional)
    - name: Upload SARIF to GitHub (Checkov)
      uses: github/codeql-action/upload-sarif@v4
      continue-on-error: true
      if: hashFiles('sarif/checkov.sarif') != ''
      with:
        sarif_file: sarif/checkov.sarif

    - name: Upload SARIF to GitHub (Terrascan)
      uses: github/codeql-action/upload-sarif@v4
      continue-on-error: true
      if: hashFiles('sarif/terrascan.sarif') != ''
      with:
        sarif_file: sarif/terrascan.sarif

    - name: Upload SARIF to GitHub (Trivy)
      uses: github/codeql-action/upload-sarif@v4
      continue-on-error: true
      if: hashFiles('sarif/trivy.sarif') != ''
      with:
        sarif_file: sarif/trivy.sarif

    - name: Upload SARIF to GitHub (Gitleaks)
      uses: github/codeql-action/upload-sarif@v4
      continue-on-error: true
      if: hashFiles('sarif/gitleaks.sarif') != ''
      with:
        sarif_file: sarif/gitleaks.sarif

    # Defender CLI
    - name: Install Defender CLI
      shell: pwsh
      continue-on-error: true
      run: |
        Invoke-WebRequest -Uri "https://aka.ms/defendercli/windows" -OutFile defendercli.zip
        Expand-Archive defendercli.zip -DestinationPath $env:USERPROFILE\defendercli -Force
        echo "$env:USERPROFILE\defendercli" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append

    - name: Upload SARIF to Microsoft Defender for Cloud
      shell: pwsh
      continue-on-error: false
      run: |
        $defenderPath = Join-Path $env:USERPROFILE "defendercli/defender.exe"
        if (-not (Test-Path $defenderPath)) {
          Write-Error "Defender CLI not found at $defenderPath"
          exit 1
        }
        & $defenderPath scan upload --sarif ./sarif --recursive
