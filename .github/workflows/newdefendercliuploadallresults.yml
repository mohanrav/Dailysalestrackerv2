
# Note by Mohan. This workflow does not fail the pipeline. 
name: Defender CLI – Upload 3rd‑party SARIF to MDC

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

permissions:
  contents: read
  id-token: write
  actions: read
  security-events: write

jobs:
  security-scan:
    runs-on: windows-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v3

    # ---------------------------------------------------------
    # 1. Run Checkov (IaC)
    # ---------------------------------------------------------
    - name: Install Checkov
      shell: pwsh
      run: pip install checkov

    - name: Run Checkov
      shell: pwsh
      continue-on-error: true
      run: checkov -d . -o sarif > checkov.sarif

    # ---------------------------------------------------------
    # 2. Run Terrascan (IaC)
    # ---------------------------------------------------------
    - name: Install Terrascan
      shell: pwsh
      run: |
        Invoke-WebRequest -Uri "https://github.com/tenable/terrascan/releases/latest/download/terrascan_windows_amd64.zip" -OutFile terrascan.zip
        Expand-Archive terrascan.zip -DestinationPath $env:USERPROFILE\terrascan
        echo "$env:USERPROFILE\terrascan" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append

    - name: Run Terrascan
      shell: pwsh
      continue-on-error: true
      run: terrascan scan -o sarif > terrascan.sarif

    # ---------------------------------------------------------
    # 3. Run Trivy (Secrets)
    # ---------------------------------------------------------
    - name: Install Trivy
      shell: pwsh
      run: |
        Invoke-WebRequest -Uri "https://github.com/aquasecurity/trivy/releases/download/v0.67.0/trivy_0.67.0_windows-64bit.zip" -OutFile trivy.zip
        Expand-Archive trivy.zip -DestinationPath $env:USERPROFILE\trivy
        echo "$env:USERPROFILE\trivy" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append

    - name: Run Trivy for secrets
      shell: pwsh
      continue-on-error: true
      run: trivy fs --scanners secret --format sarif --output trivy.sarif .

    # ---------------------------------------------------------
    # 4. Run Gitleaks (Secrets)
    # ---------------------------------------------------------
    - name: Install Gitleaks
      shell: pwsh
      run: |
        Invoke-WebRequest -Uri "https://github.com/gitleaks/gitleaks/releases/download/v8.18.1/gitleaks_8.18.1_windows_x64.zip" -OutFile gitleaks.zip
        Expand-Archive gitleaks.zip -DestinationPath $env:USERPROFILE\gitleaks
        echo "$env:USERPROFILE\gitleaks" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append

    - name: Run Gitleaks
      shell: pwsh
      continue-on-error: true
      run: gitleaks detect --report-format sarif --report-path gitleaks.sarif

    # ---------------------------------------------------------
    # 5. Upload SARIF to GitHub Security Tab (optional)
    # ---------------------------------------------------------
    - name: Upload SARIF to GitHub (Checkov)
      uses: github/codeql-action/upload-sarif@v3
      with:
        sarif_file: checkov.sarif

    - name: Upload SARIF to GitHub (Terrascan)
      uses: github/codeql-action/upload-sarif@v3
      with:
        sarif_file: terrascan.sarif

    - name: Upload SARIF to GitHub (Trivy)
      uses: github/codeql-action/upload-sarif@v3
      with:
        sarif_file: trivy.sarif

    - name: Upload SARIF to GitHub (Gitleaks)
      uses: github/codeql-action/upload-sarif@v3
      with:
        sarif_file: gitleaks.sarif

    # ---------------------------------------------------------
    # 6. Install Defender CLI
    # ---------------------------------------------------------
    - name: Install Defender CLI
      shell: pwsh
      run: |
        Invoke-WebRequest -Uri "https://aka.ms/defendercli/windows" -OutFile defendercli.zip
        Expand-Archive defendercli.zip -DestinationPath $env:USERPROFILE\defendercli
        echo "$env:USERPROFILE\defendercli" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append

    # ---------------------------------------------------------
    # 7. Upload ALL SARIF files to Microsoft Defender for Cloud
    # ---------------------------------------------------------
    - name: Upload SARIF to Microsoft Defender for Cloud
      shell: pwsh
      run: defender scan upload --sarif . --recursive
